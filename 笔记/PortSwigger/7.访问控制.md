# 访问控制漏洞和权限提升

## 什么是访问控制

访问控制（或授权）是对谁（或什么）可以执行尝试的操作或访问他们请求的资源的限制的应用。在 Web 应用程序的上下文中，访问控制依赖于身份验证和会话管理：

-   **身份验证**识别用户并确认他们就是他们所说的人。
-   **会话管理**识别同一用户正在发出哪些后续 HTTP 请求。
-   **访问控制**确定是否允许用户执行他们尝试执行的操作。

损坏的访问控制是一种常见且经常是严重的安全漏洞。访问控制的设计和管理是一个复杂且动态的问题，它将业务、组织和法律约束应用于技术实施。访问控制设计决策必须由人而不是技术做出，并且出错的可能性很高。

## 垂直访问控制

垂直访问控制是限制对其他类型用户不可用的敏感功能的访问的机制。
通过垂直访问控制，不同类型的用户可以访问不同的应用程序功能。例如，管理员可能能够修改或删除任何用户的帐户，而普通用户无权访问这些操作。垂直访问控制可以是更细粒度的安全模型实施，旨在强制执行业务策略，例如职责分离和最小权限。

## 水平访问控制

水平访问控制是一种机制，将资源的访问权限限制在特定允许访问这些资源的用户。
通过横向访问控制，不同的用户可以访问同一类型的资源子集。例如，银行应用程序将允许用户查看交易并从他们自己的账户进行支付，但不允许任何其他用户的账户。

## 上下文相关的访问控制

与上下文相关的访问控制根据应用程序的状态或用户与应用程序的交互来限制对功能和资源的访问。
与上下文相关的访问控制可防止用户以错误的顺序执行操作。例如，零售网站可能会阻止用户在付款后修改其购物车的内容。

## 纵向提权

### 未受保护的功能

在最基本的情况下，当应用程序不对敏感功能实施任何保护时，就会出现垂直权限提升。例如，管理功能可能从管理员的欢迎页面链接，而不是从用户的欢迎页面链接。但是，用户可以通过直接浏览相关的管理 URL 来访问管理功能。

例如，网站可能会在以下 URL 托管敏感功能：

`https://insecure-website.com/admin`

事实上，任何用户都可以访问它，而不仅仅是在其用户界面中具有指向该功能的链接的管理用户。在某些情况下，管理 URL 可能会在其他位置公开，例如`robots.txt`文件：

`https://insecure-website.com/robots.txt`

即使 URL 没有在任何地方公开，攻击者也可以使用单词列表来暴力破解敏感功能的位置。

某些情况下，敏感功能没有得到强有力的保护，而是通过给它一个不太可预测的 URL 来隐藏：所谓的隐蔽安全。仅仅隐藏敏感功能并不能提供有效的访问控制，因为用户仍可能以各种方式发现经过混淆的 URL。

例如，考虑在以下 URL 托管管理功能的应用程序：

`https://insecure-website.com/administrator-panel-yb556

攻击者可能无法直接猜测到这一点。但是，应用程序可能仍会将 URL 泄露给用户。例如，URL 可能在基于用户角色构建用户界面的 JavaScript 中公开：

`<script> var isAdmin = false; if (isAdmin) { ... var adminPanelTag = document.createElement('a'); adminPanelTag.setAttribute('https://insecure-website.com/administrator-panel-yb556'); adminPanelTag.innerText = 'Admin panel'; ... } </script>`

如果用户是管理员用户，此脚本会添加指向用户 UI 的链接。但是，包含 URL 的脚本对所有用户都是可见的，无论其角色如何。

### 基于参数的访问控制方法

一些应用程序在登录时确定用户的访问权限或角色，然后将此信息存储在用户可控制的位置，例如隐藏字段、cookie 或预设的查询字符串参数

`https://insecure-website.com/login/home.jsp?admin=true https://insecure-website.com/login/home.jsp?role=1`

这种方法从根本上讲是不安全的，因为用户可以简单地修改值并获得对他们无权访问的功能的访问权限，例如管理功能。

### 平台配置错误导致访问控制中断

一些应用程序通过基于用户角色限制对特定 URL 和 HTTP 方法的访问来在平台层实施访问控制。例如，应用程序可能会配置如下规则：

>DENY: POST, /admin/deleteUser, managers

此规则拒绝manager 组中的用户访问`POST`URL 上的方法。`/admin/deleteUser`在这种情况下，各种事情都可能出错，导致访问控制绕过。

一些应用程序框架支持各种非标准的 HTTP 标头，这些标头可用于覆盖原始请求中的 URL，例如`X-Original-URL`和`X-Rewrite-URL`。如果网站使用严格的前端控制来限制基于 URL 的访问，但应用程序允许通过请求标头覆盖 URL，则可以使用如下请求绕过访问控制：
>POST / HTTP/1.1 X-Original-URL: /admin/deleteUser ...

另一种攻击可能与请求中使用的 HTTP 方法有关。上面的前端控件根据 URL 和 HTTP 方法限制访问。某些网站在执行操作时可以容忍其他 HTTP 请求方法。如果攻击者可以使用`GET`（或其他）方法对受限 URL 执行操作，那么他们可以绕过在平台层实现的访问控制。

## 横向提权

当用户能够访问属于另一个用户的资源而不是他们自己的该类型资源时，就会出现水平权限提升。例如，如果一个员工应该只能访问自己的就业和工资记录，但实际上也可以访问其他员工的记录，那么这就是横向权限升级。

水平提权攻击可能使用与垂直提权类似的利用方法。例如，用户通常可以使用如下 URL 访问他们自己的帐户页面：

>https://insecure-website.com/myaccount?id=123

现在，如果攻击者将`id`参数值修改为另一个用户的参数值，那么攻击者可能会访问另一个用户的帐户页面，以及相关的数据和功能。

>id=321

在某些应用中，可利用参数没有可预测的值。例如，应用程序可能使用全局唯一标识符 (GUID) 来标识用户，而不是递增数字。在这里，攻击者可能无法猜测或预测另一个用户的标识符。但是，属于其他用户的 GUID 可能会在引用用户的应用程序的其他地方公开，例如用户消息或评论。

### 横向到纵向的权限提升

通常情况下，横向权限提升攻击可以转化为纵向权限提升，通过危害更高权限的用户。例如，水平升级可能允许攻击者重置或捕获属于另一个用户的密码。如果攻击者以管理用户为目标并破坏他们的帐户，那么他们可以获得管理访问权限，从而执行垂直权限升级。

例如，攻击者可能能够使用已经描述的用于水平权限提升的参数篡改技术来访问另一个用户的帐户页面：
>https://insecure-website.com/myaccount?id=456

如果目标用户是应用程序管理员，那么攻击者将获得对管理帐户页面的访问权限。此页面可能会泄露管理员密码或提供更改密码的方法，或者可能提供对特权功能的直接访问。

## 不安全的直接对象引用

不安全的直接对象引用 (IDOR) 是一种[访问控制](https://portswigger.net/web-security/access-control)漏洞，当应用程序使用用户提供的输入直接访问对象时会出现这种漏洞。IDOR 一词因出现在 OWASP 2007 Top 10 中而广为人知。然而，这只是可能导致绕过访问控制的许多访问控制实施错误的一个示例。IDOR 漏洞最常与水平权限提升相关，但它们也可能与垂直权限提升相关。

### 直接引用数据库对象的 IDOR 漏洞

考虑一个网站，它通过从后端数据库检索信息，使用以下 URL 访问客户帐户页面：
>https://insecure-website.com/customer_account?customer_number=132355

### 直接引用静态文件的 IDOR 漏洞
当敏感资源位于服务器端文件系统的静态文件中时，通常会出现 IDOR 漏洞。例如，网站可能使用递增的文件名将聊天消息记录保存到磁盘，并允许用户通过访问如下 URL 来检索这些记录：
>https://insecure-website.com/static/12144.txt

## 多步骤流程中的访问控制漏洞

许多网站通过一系列步骤实现重要功能。当需要捕获各种输入或选项时，或者当用户需要在执行操作之前查看和确认详细信息时，通常会执行此操作。例如，更新用户详细信息的管理功能可能涉及以下步骤：

1.  加载包含特定用户详细信息的表单。
2.  提交更改。
3.  查看更改并确认。

有时，网站会对其中一些步骤实施严格的访问控制，而忽略其他步骤。例如，假设访问控制正确应用于第一步和第二步，但没有应用于第三步。实际上，网站假设用户只有在完成了正确控制的第一步后才能到达第 3 步。在这里，攻击者可以通过跳过前两个步骤并直接提交带有所需参数的第三步请求来获得对该功能的未经授权的访问。

## 基于Referer的访问控制

`Referer`一些网站基于HTTP 请求中提交 的标头进行访问控制。标`Referer`头通常添加到浏览器的请求中，以指示发起请求的页面。

例如，假设一个应用程序对位于 的主管理页面强制执行访问控制`/admin`，但对子页面（例如`/admin/deleteUser`仅检查`Referer`标题）执行访问控制。如果`Referer`标头包含主`/admin`URL，则允许请求。

在这种情况下，由于`Referer`攻击者可以完全控制标头，因此他们可以伪造对敏感子页面的直接请求，提供所需的`Referer`标头，从而获得未经授权的访问。