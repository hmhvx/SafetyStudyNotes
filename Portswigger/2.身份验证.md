# 身份验证漏洞

身份验证是验证给定用户或客户端身份的过程。换句话说，它涉及确保他们确实是他们声称的人。至少在某种程度上，网站会暴露给任何通过设计连接到互联网的人。因此，强大的身份验证机制是有效网络安全的一个组成部分。

可以将不同类型的身份验证分为三个身份验证因素：

- 您知道的信息，例如密码或安全问题的答案。这些有时被称为“知识因素”。
- 您拥有的东西，即诸如手机或安全令牌之类的物理对象。这些有时被称为“占有因素”。
- 你是什么或做什么，例如，你的生物特征或行为模式。这些有时被称为“内在因素”。

身份验证机制依赖于一系列技术来验证这些因素中的一个或多个。

## 基于密码的登入

对于采用基于密码登录过程的网站，用户要么自己注册一个帐户，要么由管理员分配一个帐户。该帐户与一个唯一的用户名和一个秘密密码相关联，用户在登录表单中输入这些密码来验证自己的身份。

在这种情况下，他们知道秘密密码这一事实就被视为用户身份的充分证明。因此，如果攻击者能够获取或猜测另一个用户的登录凭据，网站的安全性就会受到损害。

*暴力破解用户名*

如果用户名符合可识别的模式，例如电子邮件地址，则特别容易猜到。例如，以 . 格式查看业务登录非常常见`firstname.lastname@somecompany.com`。但是，即使没有明显的模式，有时甚至是使用可预测的用户名（例如`admin`或）创建高权限帐户`administrator`。
在审核期间，检查网站是否公开披露潜在用户名。例如，您是否能够在不登录的情况下访问用户配置文件？即使配置文件的实际内容被隐藏，配置文件中使用的名称有时与登录用户名相同。您还应该检查 HTTP 响应以查看是否有任何电子邮件地址被泄露。有时，回复中包含管理员和 IT 支持等高特权用户的电子邮件地址。

*暴力破解密码*

密码可以类似地被暴力破解，难度根据密码的强度而变化。许多网站采用某种形式的密码策略，迫使用户创建高熵密码，至少在理论上，仅使用暴力破解更难。这通常涉及通过以下方式强制执行密码：
* 最少字符数
* 小写和大写字母的混合
* 至少一个特殊字符
然而，虽然高熵密码仅靠计算机很难破解，但我们可以利用人类行为的基本知识来利用用户在不知不觉中引入该系统的漏洞。用户通常不会使用随机字符组合创建强密码，而是使用他们可以记住的密码并尝试将其撬开以适应密码策略。例如，如果mypassword不允许，用户可以尝试类似Mypassword1!orMyp4之类的东西。
在策略要求用户定期更改密码的情况下，用户通常只需对其首选密码进行微小的、可预测的更改。例如，Mypassword1!变成Mypassword1?或Mypassword2!.
这种对可能凭据和可预测模式的了解意味着暴力攻击通常比简单地遍历每个可能的字符组合要复杂得多，因此也更有效。

### 通过不同响应枚举

>**状态码**：在蛮力攻击期间，返回的 HTTP 状态码对于绝大多数猜测可能是相同的，因为大多数猜测都是错误的。如果猜测返回不同的状态代码，这强烈表明用户名是正确的。无论结果如何，网站始终返回相同的状态代码是最佳做法，但并不总是遵循这种做法

### 通过细微不同响应枚举

>**错误消息**：有时返回的错误消息会有所不同，具体取决于用户名和密码是否不正确或只有密码不正确。网站的最佳做法是在这两种情况下使用相同的通用消息，但有时会出现小的输入错误。即使一个字符不合适，这两条消息也会不同，即使在呈现页面上看不到该字符的情况下也是如此。

### 通过响应时间枚举用户名

>**响应时间**：如果大多数请求都以相似的响应时间处理，那么任何偏离此时间的请求都表明幕后正在发生不同的事情。这是猜测的用户名可能是正确的另一个迹象。例如，网站可能仅在用户名有效时才检查密码是否正确。这个额外的步骤可能会导致响应时间略有增加。这可能是微妙的，但攻击者可以通过输入一个过长的密码来使这种延迟更加明显，该网站需要明显更长的时间来处理。

### 通过有缺陷的蛮力保护

系统防止暴力攻击的两种最常见的方法是：

* 如果远程用户尝试登录失败次数过多，则锁定他们尝试访问的帐户
* 如果远程用户连续快速登录尝试次数过多，则阻止远程用户的 IP 地址

*两种方法都提供不同程度的保护，但都不是无懈可击的，尤其是在使用有缺陷的逻辑实施时*
>例如，如果您多次登录失败，您有时可能会发现您的 IP 被阻止。在一些实施方式中，如果 IP 所有者成功登录，则失败尝试次数的计数器会重置。这意味着攻击者只需每隔几次尝试登录自己的帐户即可防止达到此限制。

### 通过账号锁定

网站试图防止暴力破解的一种方法是在满足某些可疑条件时锁定帐户，通常是一定次数的失败登录尝试。就像正常的登录错误一样，来自服务器的指示帐户被锁定的响应也可以帮助攻击者枚举用户名。

锁定帐户可提供一定程度的保护，防止针对特定帐户的有针对性的暴力破解。但是，这种方法无法充分防止暴力攻击，其中攻击者只是试图访问他们可以访问的任何随机帐户。

例如，可以使用以下方法来解决这种保护：
1.  建立一个可能有效的候选用户名列表。这可以通过用户名枚举或简单地基于常见用户名列表。
2.  确定一个您认为至少有一个用户可能拥有的非常小的密码候选名单。至关重要的是，您选择的密码数量不得超过允许的登录尝试次数。例如，如果您计算出该限制为 3 次尝试，则您需要选择最多 3 次密码猜测。
3.  使用 Burp Intruder 等工具，使用每个候选用户名尝试每个选定的密码。这样，您可以尝试在不触发帐户锁定的情况下暴力破解每个帐户。您只需要一个用户使用三个密码中的一个就可以破坏帐户。

帐户锁定也无法防止撞库攻击。这涉及使用大量的username:password配对字典，其中包含在数据泄露中被盗的真实登录凭据。凭据填充依赖于许多人在多个网站上重复使用相同的用户名和密码这一事实，因此，字典中的某些受损凭据有可能在目标网站上也有效。帐户锁定不能防止凭证填充，因为每个用户名仅被尝试一次。凭证填充特别危险，因为它有时会导致攻击者仅通过一次自动攻击就破坏许多不同的帐户。

*通过观察响应时间/响应长度判断用户/密码的存在*

### 通过用户速率限制

网站试图防止暴力攻击的另一种方法是通过用户速率限制。在这种情况下，在短时间内发出过多的登录请求会导致您的 IP 地址被阻止。通常，只能通过以下方式之一解锁 IP：
-   经过一定时间后自动
-   由管理员手动
-   成功完成验证码后由用户手动完成

由于不太容易受到用户名枚举和拒绝服务攻击，用户速率限制有时优于帐户锁定。但是，它仍然不是完全安全的。正如我们在早期实验室中看到的一个示例，攻击者可以通过多种方式操纵其明显的 IP 以绕过该块。

>由于该限制基于从用户 IP 地址发送的 HTTP 请求的速率，因此如果您能弄清楚如何通过单个请求猜测多个密码，有时也可以绕过此防御。
>"username" : "carlos",
>"password" : ["123456","password","qwerty" ...]


## 多因素身份验证

### 绕过双重身份验证

>如果首先提示用户输入密码，然后在单独的页面上提示输入验证码，则用户在输入验证码之前实际上处于“登录”状态。在这种情况下，值得进行测试，看看您是否可以在完成第一个身份验证步骤后直接跳到“仅登录”页面。有时，您会发现网站实际上并没有在加载页面之前检查您是否完成了第二步。

### 有缺陷的双重验证逻辑

有时，双因素身份验证中的逻辑缺陷意味着在用户完成初始登录步骤后，网站无法充分验证同一用户是否正在完成第二步。

1. 例如，用户在第一步中使用其正常凭据登录。
2. 然后，在进入登录过程的第二步之前，他们会被分配一个与其帐户相关的 cookie。
3. 提交验证码时，请求使用此 cookie 来确定用户尝试访问的帐户。
4. 在这种情况下，攻击者可以使用自己的凭据登录，然后`account`在提交验证码时将 cookie 的值更改为任意用户名。

如果攻击者随后能够暴力破解验证码，这是非常危险的，因为这将允许他们完全基于用户名登录任意用户的帐户。他们甚至不需要知道用户的密码。

### 通过枚举绕过2FA

与密码一样，网站需要采取措施防止 2FA 验证码的暴力破解。这一点尤其重要，因为代码通常是一个简单的 4 位或 6 位数字。如果没有足够的蛮力保护，破解这样的代码是微不足道的。

如果用户输入了一定数量的错误验证码，一些网站会尝试通过自动注销用户来防止这种情况发生。这在实践中是无效的，因为高级攻击者甚至可以通过为 Burp Intruder创建宏来自动化这个多步骤过程。Turbo Intruder扩展也可用于此目的 。

在 Burp 中，转到**Project options > Sessions**,在**Session Handling Rules**，单击**Add**.在**Session handling rule editor**点开。
在对话框中，转到**Scope**选项卡。在 **URL Scope**下，选择选项**Include all URLs**。
返回 **Details**选项卡并在**Rule Actions**下，单击**Add > Run a macro**.
在**Select macro**下单击**Add**以打开**Macro Recorder**。选择以下 3 个请求
`GET /login 
POST /login 
GET /login2`
然后单击**OK**。**Macro Editor**对话框打开。
继续单击**OK**关闭各种对话框，直到您返回 Burp 主窗口。在 Burp Intruder 发送每个请求之前，宏现在会自动将您重新登录为 Carlos。

## 其他身份验证机制

### 保持用户登录

一个常见功能是即使在关闭浏览器会话后也可以保持登录状态。这通常是一个简单的复选框，标有“记住我”或“让我登录”之类的标签。

此功能通常通过生成某种“记住我”令牌来实现，然后将其存储在持久 cookie 中。由于有效地拥有此 cookie 可以让您绕过整个登录过程，因此最佳实践是让此 cookie 无法猜测。但是，某些网站会根据可预测的静态值串联生成此 cookie，例如用户名和时间戳。有些甚至使用密码作为 cookie 的一部分。如果攻击者能够创建自己的帐户，这种方法尤其危险，因为他们可以研究自己的 cookie 并可能推断出它是如何生成的。一旦他们制定出公式，他们就可以尝试暴力破解其他用户的 cookie 以访问他们的帐户。

一些网站假设如果 cookie 以某种方式加密，即使它确实使用静态值，它也不会被猜测。虽然如果正确完成这可能是正确的，但使用像 Base64 这样简单的双向编码天真地“加密”cookie 不会提供任何保护。即使使用具有单向哈希函数的适当加密也不是完全安全的。如果攻击者能够轻松识别散列算法，并且不使用盐，他们可能会通过简单地散列其单词列表来暴力破解 cookie。如果类似的限制不适用于 cookie 猜测，则此方法可用于绕过登录尝试限制。

即使攻击者无法创建自己的帐户，他们仍然可以利用此漏洞。使用通常的技术，例如XSS，攻击者可以窃取另一个用户的“记住我”cookie，并由此推断 cookie 是如何构造的。如果网站是使用开源框架构建的，那么 cookie 构建的关键细节甚至可能会被公开记录。

在极少数情况下，即使经过哈希处理，也可以从 cookie 中以明文形式获取用户的实际密码。众所周知的密码列表的散列版本可在线获得，因此如果用户的密码出现在这些列表之一中，解密散列有时就像将散列粘贴到搜索引擎中一样简单。这证明了盐在有效加密中的重要性。

### 重置用户密码

在实践中，某些用户会忘记他们的密码是给定的，因此通常有办法让他们重置密码。由于在这种情况下通常基于密码的身份验证显然是不可能的，因此网站必须依靠替代方法来确保真实用户正在重置自己的密码。出于这个原因，密码重置功能本质上是危险的，需要安全地实施。

通常实现此功能有几种不同的方式，具有不同程度的漏洞。

#### 通过电子邮件发送密码

不用说，如果网站首先安全地处理密码，就永远不可能向用户发送他们当前的密码。相反，一些网站会生成一个新密码并通过电子邮件将其发送给用户。

一般来说，应避免通过不安全的渠道发送持久密码。在这种情况下，安全性取决于生成的密码在很短的时间后过期，或者用户立即再次更改密码。否则，这种方法很容易受到中间人攻击。

鉴于收件箱是持久性的并且并非真正为机密信息的安全存储而设计，因此电子邮件通常也不被认为是安全的。许多用户还通过不安全的渠道在多个设备之间自动同步他们的收件箱

#### 使用URL重置密码

一种更强大的重置密码的方法是向用户发送一个唯一的 URL，将他们带到密码重置页面。此方法的不太安全的实现使用带有易于猜测的参数的 URL 来识别正在重置的帐户，例如：

* http://vulnerable-website.com/reset-password?user=victim-user

在此示例中，攻击者可以更改user参数以引用他们已识别的任何用户名。然后他们将被直接带到一个页面，在那里他们可以为这个任意用户设置一个新密码。

这个过程的一个更好的实现是生成一个高熵、难以猜测的令牌，并基于它创建重置 URL。在最佳情况下，此 URL 不应提供有关正在重置哪个用户密码的提示。

* http://vulnerable-website.com/reset-password?token=a0ba0d1cb3b63d13822572fcff1a241895d893f659164d4cc550b421ebdd48a8

当用户访问此 URL 时，系统应检查后端是否存在此令牌，如果存在，则应重置哪个用户的密码。此令牌应在短时间内过期，并在重置密码后立即销毁。

但是，某些网站在提交重置表单时也无法再次验证令牌。在这种情况下，攻击者可以简单地从他们自己的帐户访问重置表单，删除令牌，然后利用此页面重置任意用户的密码。

*密码重置中毒*
如果重置邮件中的 URL 是动态生成的，这也可能容易受到密码重置中毒的影响。在这种情况下，攻击者可能会窃取另一个用户的令牌并使用它来更改他们的密码。

### 更改密码

通常，更改密码需要输入当前密码，然后输入两次新密码。这些页面基本上依赖于检查用户名和当前密码是否匹配正常登录页面的相同过程。因此，这些页面可能容易受到相同技术的攻击。

如果密码更改功能允许攻击者直接访问它而不以受害者用户身份登录，它可能会特别危险。例如，如果在隐藏字段中提供了用户名，攻击者可能能够在请求中编辑此值以针对任意用户。这可能被利用来枚举用户名和暴力密码。


